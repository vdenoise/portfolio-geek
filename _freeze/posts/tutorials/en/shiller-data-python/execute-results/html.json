{
  "hash": "5705a3168e96624006efcea4db2fe575",
  "result": {
    "markdown": "---\ntitle: Analyzing Equity long Term Returns with Python\ncategories: [tutorial, long term investing, en]\njupyter: python3\nexecute:\n    freeze: auto\n--- \n\n\n\n::: {.content-visible when-profile=\"presentation\"}\n::: {.notes}\n### Intro\nHello everyone and welcome to this first video of the Portfolio Geek channel. In this video we will look at what long term investing means for Equity investors.\nMany investors think about stock trades and financial analysis, selecting the best stock based on its value, cash flow dividends, and then looking at entry points, trying to find the best timing to exit and so forth. \n\nNote: ideally, bullet points on green screen to make sure it goes as key holding points.\n\n### Structure of the 10 minutes\nWhat I will aim to do in the next 10 minutes is to provide you with some perspective on why long term investing makes sense, and how it might actually provide very good returns as long as the investor is sufficiently patient about it. \nTo do so, I will look at 2 online databases with free access to everyone:\n* The first one is a famous one, launched by Robert Shiller, extremely well known in the finance and academic community. It provides everyone with the long term returns of the S&P 500, ie the reference of US Large Cap Equities\n* The second one is called the Maddison Project, launched by the university of Maddison in []. It's a fantastic resource for academics as it that compiles what is probably the most comprehensive dataset on historical gdp and gdp per capita across countries. We will dive more into this database in an other video.\n\n### Tools\nTo put everything together, we will use :\n* The python language\n* More precisely we will build a Jupyter Notebook, that enables to write, analyse, chart in the same environment\n* Several libraries: requests (web request), pandas for data wrangling, scipy for regressions, and matplotlib\n\nBut now enough talking, let's go right into it!\n\n long term Equity return database, and the other is called\n:::\n:::\n\n::: {.content-visible when-profile=\"website\"}\n![](/pictures/time-horizon-paper.png)\n\n## Introduction\nLong Term Investing enables investors to capture the long term risk premium of various asset classes.\n\nIn this article, we will explore how to download Shiller's Excel data on long-term stock market returns from his website using Python. We will use the requests library for HTTP requests and the pandas library for data manipulation. For visualization, we will use the Matplotlib library with the Pacoty stylesheet to create a chart comparing nominal equity returns, real equity returns, and real GDP growth.\n\n## Downloading Shiller's Data\n\nFirst, we need to import the required libraries and download the data using an HTTP request:\n\nThis code below downloads the Excel file from Shiller's website, directly into memory, and reads it into a pandas DataFrame.\n:::\n\n::: {.cell execution_count=2}\n``` {.python .cell-code}\nimport requests\nimport pandas as pd\nfrom io import BytesIO\nimport dataframe_image as dfi\n\nurl = \"http://www.econ.yale.edu/~shiller/data/ie_data.xls\"\n\nresponse = requests.get(url)\n\ndef make_pretty(styler):\n    styler.format(precision=2)\n    return styler\n\n# Check if the request was successful\nif response.status_code == 200:\n    data = pd.read_excel(BytesIO(response.content), sheet_name='Data', header=7)\nelse:\n    print(\"Failed to download the data\")\n\ndata.iloc[1:10, 1:5].style.pipe(make_pretty)\n\n\n```\n\n::: {.cell-output .cell-output-display execution_count=2}\n```{=html}\n<style type=\"text/css\">\n</style>\n<table id=\"T_e70f0\">\n  <thead>\n    <tr>\n      <th class=\"blank level0\" >&nbsp;</th>\n      <th id=\"T_e70f0_level0_col0\" class=\"col_heading level0 col0\" >P</th>\n      <th id=\"T_e70f0_level0_col1\" class=\"col_heading level0 col1\" >D</th>\n      <th id=\"T_e70f0_level0_col2\" class=\"col_heading level0 col2\" >E</th>\n      <th id=\"T_e70f0_level0_col3\" class=\"col_heading level0 col3\" >CPI</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th id=\"T_e70f0_level0_row0\" class=\"row_heading level0 row0\" >1</th>\n      <td id=\"T_e70f0_row0_col0\" class=\"data row0 col0\" >4.50</td>\n      <td id=\"T_e70f0_row0_col1\" class=\"data row0 col1\" >0.26</td>\n      <td id=\"T_e70f0_row0_col2\" class=\"data row0 col2\" >0.40</td>\n      <td id=\"T_e70f0_row0_col3\" class=\"data row0 col3\" >12.84</td>\n    </tr>\n    <tr>\n      <th id=\"T_e70f0_level0_row1\" class=\"row_heading level0 row1\" >2</th>\n      <td id=\"T_e70f0_row1_col0\" class=\"data row1 col0\" >4.61</td>\n      <td id=\"T_e70f0_row1_col1\" class=\"data row1 col1\" >0.26</td>\n      <td id=\"T_e70f0_row1_col2\" class=\"data row1 col2\" >0.40</td>\n      <td id=\"T_e70f0_row1_col3\" class=\"data row1 col3\" >13.03</td>\n    </tr>\n    <tr>\n      <th id=\"T_e70f0_level0_row2\" class=\"row_heading level0 row2\" >3</th>\n      <td id=\"T_e70f0_row2_col0\" class=\"data row2 col0\" >4.74</td>\n      <td id=\"T_e70f0_row2_col1\" class=\"data row2 col1\" >0.26</td>\n      <td id=\"T_e70f0_row2_col2\" class=\"data row2 col2\" >0.40</td>\n      <td id=\"T_e70f0_row2_col3\" class=\"data row2 col3\" >12.56</td>\n    </tr>\n    <tr>\n      <th id=\"T_e70f0_level0_row3\" class=\"row_heading level0 row3\" >4</th>\n      <td id=\"T_e70f0_row3_col0\" class=\"data row3 col0\" >4.86</td>\n      <td id=\"T_e70f0_row3_col1\" class=\"data row3 col1\" >0.26</td>\n      <td id=\"T_e70f0_row3_col2\" class=\"data row3 col2\" >0.40</td>\n      <td id=\"T_e70f0_row3_col3\" class=\"data row3 col3\" >12.27</td>\n    </tr>\n    <tr>\n      <th id=\"T_e70f0_level0_row4\" class=\"row_heading level0 row4\" >5</th>\n      <td id=\"T_e70f0_row4_col0\" class=\"data row4 col0\" >4.82</td>\n      <td id=\"T_e70f0_row4_col1\" class=\"data row4 col1\" >0.26</td>\n      <td id=\"T_e70f0_row4_col2\" class=\"data row4 col2\" >0.40</td>\n      <td id=\"T_e70f0_row4_col3\" class=\"data row4 col3\" >12.08</td>\n    </tr>\n    <tr>\n      <th id=\"T_e70f0_level0_row5\" class=\"row_heading level0 row5\" >6</th>\n      <td id=\"T_e70f0_row5_col0\" class=\"data row5 col0\" >4.73</td>\n      <td id=\"T_e70f0_row5_col1\" class=\"data row5 col1\" >0.26</td>\n      <td id=\"T_e70f0_row5_col2\" class=\"data row5 col2\" >0.40</td>\n      <td id=\"T_e70f0_row5_col3\" class=\"data row5 col3\" >12.08</td>\n    </tr>\n    <tr>\n      <th id=\"T_e70f0_level0_row6\" class=\"row_heading level0 row6\" >7</th>\n      <td id=\"T_e70f0_row6_col0\" class=\"data row6 col0\" >4.79</td>\n      <td id=\"T_e70f0_row6_col1\" class=\"data row6 col1\" >0.26</td>\n      <td id=\"T_e70f0_row6_col2\" class=\"data row6 col2\" >0.40</td>\n      <td id=\"T_e70f0_row6_col3\" class=\"data row6 col3\" >11.89</td>\n    </tr>\n    <tr>\n      <th id=\"T_e70f0_level0_row7\" class=\"row_heading level0 row7\" >8</th>\n      <td id=\"T_e70f0_row7_col0\" class=\"data row7 col0\" >4.84</td>\n      <td id=\"T_e70f0_row7_col1\" class=\"data row7 col1\" >0.26</td>\n      <td id=\"T_e70f0_row7_col2\" class=\"data row7 col2\" >0.40</td>\n      <td id=\"T_e70f0_row7_col3\" class=\"data row7 col3\" >12.18</td>\n    </tr>\n    <tr>\n      <th id=\"T_e70f0_level0_row8\" class=\"row_heading level0 row8\" >9</th>\n      <td id=\"T_e70f0_row8_col0\" class=\"data row8 col0\" >4.59</td>\n      <td id=\"T_e70f0_row8_col1\" class=\"data row8 col1\" >0.26</td>\n      <td id=\"T_e70f0_row8_col2\" class=\"data row8 col2\" >0.40</td>\n      <td id=\"T_e70f0_row8_col3\" class=\"data row8 col3\" >12.37</td>\n    </tr>\n  </tbody>\n</table>\n```\n:::\n:::\n\n\n## Downloading Maddison Project GDP Data\n\n::: {.cell execution_count=3}\n``` {.python .cell-code}\nurl = \"https://www.rug.nl/ggdc/historicaldevelopment/maddison/data/mpd2020.xlsx\"\n\nresponse = requests.get(url)\n\ndef make_pretty(styler):\n    styler.format(precision=2)\n    return styler\n\n# Check if the request was successful\nif response.status_code == 200:\n    data_gdp= pd.read_excel(BytesIO(response.content),sheet_name=\"Full data\", header=0)\nelse:\n    print(\"Failed to download the data\")\n```\n:::\n\n\n::: {.cell execution_count=4}\n``` {.python .cell-code}\nimport numpy.ma as ma\ndata_gdp[\"gdp\"] = data_gdp.gdppc * data_gdp[\"pop\"]\ndates = ma.array(\n    [f'{y}-{12}-{31}' for y in data_gdp.year.to_list()],\n    dtype='datetime64[D]'\n    )\n\ndata_gdp[\"date\"] = dates.tolist()\ndata_gdp.set_index(\"date\", inplace=True)\ndata_gdp.iloc[1:10, 1:5].style.pipe(make_pretty)\n```\n\n::: {.cell-output .cell-output-display execution_count=4}\n```{=html}\n<style type=\"text/css\">\n</style>\n<table id=\"T_4d69b\">\n  <thead>\n    <tr>\n      <th class=\"blank level0\" >&nbsp;</th>\n      <th id=\"T_4d69b_level0_col0\" class=\"col_heading level0 col0\" >country</th>\n      <th id=\"T_4d69b_level0_col1\" class=\"col_heading level0 col1\" >year</th>\n      <th id=\"T_4d69b_level0_col2\" class=\"col_heading level0 col2\" >gdppc</th>\n      <th id=\"T_4d69b_level0_col3\" class=\"col_heading level0 col3\" >pop</th>\n    </tr>\n    <tr>\n      <th class=\"index_name level0\" >date</th>\n      <th class=\"blank col0\" >&nbsp;</th>\n      <th class=\"blank col1\" >&nbsp;</th>\n      <th class=\"blank col2\" >&nbsp;</th>\n      <th class=\"blank col3\" >&nbsp;</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th id=\"T_4d69b_level0_row0\" class=\"row_heading level0 row0\" >1870-12-31</th>\n      <td id=\"T_4d69b_row0_col0\" class=\"data row0 col0\" >Afghanistan</td>\n      <td id=\"T_4d69b_row0_col1\" class=\"data row0 col1\" >1870</td>\n      <td id=\"T_4d69b_row0_col2\" class=\"data row0 col2\" >nan</td>\n      <td id=\"T_4d69b_row0_col3\" class=\"data row0 col3\" >4207.00</td>\n    </tr>\n    <tr>\n      <th id=\"T_4d69b_level0_row1\" class=\"row_heading level0 row1\" >1913-12-31</th>\n      <td id=\"T_4d69b_row1_col0\" class=\"data row1 col0\" >Afghanistan</td>\n      <td id=\"T_4d69b_row1_col1\" class=\"data row1 col1\" >1913</td>\n      <td id=\"T_4d69b_row1_col2\" class=\"data row1 col2\" >nan</td>\n      <td id=\"T_4d69b_row1_col3\" class=\"data row1 col3\" >5730.00</td>\n    </tr>\n    <tr>\n      <th id=\"T_4d69b_level0_row2\" class=\"row_heading level0 row2\" >1950-12-31</th>\n      <td id=\"T_4d69b_row2_col0\" class=\"data row2 col0\" >Afghanistan</td>\n      <td id=\"T_4d69b_row2_col1\" class=\"data row2 col1\" >1950</td>\n      <td id=\"T_4d69b_row2_col2\" class=\"data row2 col2\" >1156.00</td>\n      <td id=\"T_4d69b_row2_col3\" class=\"data row2 col3\" >8150.00</td>\n    </tr>\n    <tr>\n      <th id=\"T_4d69b_level0_row3\" class=\"row_heading level0 row3\" >1951-12-31</th>\n      <td id=\"T_4d69b_row3_col0\" class=\"data row3 col0\" >Afghanistan</td>\n      <td id=\"T_4d69b_row3_col1\" class=\"data row3 col1\" >1951</td>\n      <td id=\"T_4d69b_row3_col2\" class=\"data row3 col2\" >1170.00</td>\n      <td id=\"T_4d69b_row3_col3\" class=\"data row3 col3\" >8284.00</td>\n    </tr>\n    <tr>\n      <th id=\"T_4d69b_level0_row4\" class=\"row_heading level0 row4\" >1952-12-31</th>\n      <td id=\"T_4d69b_row4_col0\" class=\"data row4 col0\" >Afghanistan</td>\n      <td id=\"T_4d69b_row4_col1\" class=\"data row4 col1\" >1952</td>\n      <td id=\"T_4d69b_row4_col2\" class=\"data row4 col2\" >1189.00</td>\n      <td id=\"T_4d69b_row4_col3\" class=\"data row4 col3\" >8425.00</td>\n    </tr>\n    <tr>\n      <th id=\"T_4d69b_level0_row5\" class=\"row_heading level0 row5\" >1953-12-31</th>\n      <td id=\"T_4d69b_row5_col0\" class=\"data row5 col0\" >Afghanistan</td>\n      <td id=\"T_4d69b_row5_col1\" class=\"data row5 col1\" >1953</td>\n      <td id=\"T_4d69b_row5_col2\" class=\"data row5 col2\" >1240.00</td>\n      <td id=\"T_4d69b_row5_col3\" class=\"data row5 col3\" >8573.00</td>\n    </tr>\n    <tr>\n      <th id=\"T_4d69b_level0_row6\" class=\"row_heading level0 row6\" >1954-12-31</th>\n      <td id=\"T_4d69b_row6_col0\" class=\"data row6 col0\" >Afghanistan</td>\n      <td id=\"T_4d69b_row6_col1\" class=\"data row6 col1\" >1954</td>\n      <td id=\"T_4d69b_row6_col2\" class=\"data row6 col2\" >1245.00</td>\n      <td id=\"T_4d69b_row6_col3\" class=\"data row6 col3\" >8728.00</td>\n    </tr>\n    <tr>\n      <th id=\"T_4d69b_level0_row7\" class=\"row_heading level0 row7\" >1955-12-31</th>\n      <td id=\"T_4d69b_row7_col0\" class=\"data row7 col0\" >Afghanistan</td>\n      <td id=\"T_4d69b_row7_col1\" class=\"data row7 col1\" >1955</td>\n      <td id=\"T_4d69b_row7_col2\" class=\"data row7 col2\" >1246.00</td>\n      <td id=\"T_4d69b_row7_col3\" class=\"data row7 col3\" >8891.00</td>\n    </tr>\n    <tr>\n      <th id=\"T_4d69b_level0_row8\" class=\"row_heading level0 row8\" >1956-12-31</th>\n      <td id=\"T_4d69b_row8_col0\" class=\"data row8 col0\" >Afghanistan</td>\n      <td id=\"T_4d69b_row8_col1\" class=\"data row8 col1\" >1956</td>\n      <td id=\"T_4d69b_row8_col2\" class=\"data row8 col2\" >1278.00</td>\n      <td id=\"T_4d69b_row8_col3\" class=\"data row8 col3\" >9062.00</td>\n    </tr>\n  </tbody>\n</table>\n```\n:::\n:::\n\n\n## Cleanup and Columns Renaming\n\n::: {.cell execution_count=5}\n``` {.python .cell-code}\n#Excel Import is mixing up columns, re-titling them\ndata.columns = [\"Date\", \"S&P Composite\", \"Dividend (D)\", \"Earnings (E)\", \"Consumer Price Index (CPI)\", \"Date Fraction\", \"Long Interest Rate (I)\", \"Real Price\", \"Real Dividend\", \"Real Total Return Price\", \"Real Earnings\", \"Real TR Scaled Earnings\", \"CAPE\", \"\", \"TR CAPE\", \"\", \"Excess CAPE Yield\", \"Monthly Total Bond Returns\", \"Real Total Bond Returns\", \"10Y Ann Stock Real Return\", \"10Y Ann Bon Real Return\", \"Real 10Y Ann Excess Return\"]\ndata = data[:-2]\ndata[\"date\"] = pd.to_datetime(data['Date'].map('{:.2f}'.format), format='%Y.%m')\ndata.set_index(\"date\", inplace=True)\ndata[\"Price Return\"] = data[\"Real Price\"].div(data[\"Real Price\"].iloc[0])\ndata[\"Total Return\"] = data.loc[:, \"Real Total Return Price\"].div(data[\"Real Total Return Price\"].iloc[0])\ndata[\"CPI\"] = data.loc[:, \"Consumer Price Index (CPI)\"].div(data[\"Consumer Price Index (CPI)\"].iloc[0])\n\n\n```\n:::\n\n\n## Visualizing the Data with Matplotlib and Pacoty\n\n::: {.content-visible when-profile=\"website\"}\nNext, we will create a chart comparing the nominal equity returns, real equity returns, and real GDP growth using Matplotlib and the Pacoty.\nLet's start with a first sanity check on the data.\n:::\n\n\n![Dataframe](shiller-data.png)\n\n::: {.content-visible when-profile=\"website\"}\nThis code snippet creates a chart with a logarithmic scale, comparing nominal equity returns, real equity returns, and real GDP growth over time.\n:::\n\n## Long Term Equity Returns\n\n\n::: {.cell execution_count=7}\n``` {.python .cell-code}\nimport matplotlib.pyplot as plt\nimport numpy as np\nfrom scipy.ndimage import gaussian_filter1d\nfrom scipy import interpolate\nimport highlight_text as ht\nfrom highlight_text import HighlightText, ax_text, fig_text\nimport matplotlib.dates as mdates\nimport datetime as dt\nfrom scipy import stats\n\n\ndef decyear4(year, month, day, h=0, m=0, s=0):\n    return year + ((30.4375*(month-1) + day-1)*24+h)*3600/31557600.0 \n\n# Set the Pacoty stylesheet\nmpl_style = \"revealjs_whiteboard\"\nplt.style.use(f'../../stylesheets/{mpl_style}.mplstyle')\n\n# Create a figure and axis\nfig, ax = plt.subplots()\n \n# Extract the data we need\nus_gdp = data_gdp[data_gdp.countrycode == \"USA\"].gdp\ndates = data[[\"Real Price\"]].resample(\"Y\").last().index\nus_gdp.index = [dt.datetime.combine(dat, dt.time()) for dat in us_gdp.index]\nus_gdp = us_gdp[us_gdp.index >= dates.min()]\nus_gdp = us_gdp / us_gdp.iloc[0]\nreal_tr = list(data['Price Return'].resample(\"Y\").last().values)\nreal_pr = list(data[\"Total Return\"].resample(\"Y\").last().values)\ncpi = list(data[\"CPI\"].resample(\"Y\").last().values)\n\n#gdp_growth = data['Real GDP Growth']\n\n# Plot the data on a logarithmic scale\n\nf_real_tr= interpolate.interp1d(dates.year, real_tr, 'cubic')\nf_real_pr = interpolate.interp1d(dates.year, real_pr, 'cubic')\n\nreal_tr_interpol = f_real_tr(dates.year)\nreal_pr_interpol = f_real_pr(dates.year)\n\nstats.linregress(dates.year, real_tr)\n\nax.semilogy(dates, real_pr_interpol)\nax.semilogy(dates, real_tr_interpol)\nax.semilogy(us_gdp.index, us_gdp)\n#ax.semilogy(dates, cpi)\n\n#ax.semilogy(years, data[])\n\nsize = plt.rcParams['font.size']\nhighlight_textprops =[{\"fontsize\": size + 4},\n                      {\"fontsize\": size}]\n\nHighlightText(x=0.5, y=0.98, ha='center', \n              s='<Long Term Equity Returns>\\n<Equity vs GDP Growth and Inflation>',\n              highlight_textprops=highlight_textprops,\n              annotationbbox_kw={'boxcoords': fig.transFigure}, textalign=\"center\")\n\n# Customize the chart\nax.set_xlabel('Years')\nax.set_ylabel(f'Value, basis 1 in {(data.index.min().strftime(\"%d.%m.%Y\"))}')\n#ax.set_title('Long Term Equity Returns')\nfig.legend(labels = [\"US Equity: Price (Real)\", \"US Equity: Price & Divs (Real)\", \"US GDP (Real)\"], loc=\"lower left\", ncol=2, bbox_to_anchor=(0.05, -0.075, 0.5, 0.5))\nax.xaxis.set_major_locator(mdates.YearLocator(30))\nax.xaxis.set_major_formatter(\n    mdates.ConciseDateFormatter(ax.xaxis.get_major_locator()))\n\n# Show the chart\nplt.show()\nplt.close()\n#fig.savefig(\"shiller-returns.png\")  \n```\n\n::: {.cell-output .cell-output-display}\n![Long term equity returns vs CPI](shiller-data-python_files/figure-html/long-term-return-output-1.png){#long-term-return}\n:::\n:::\n\n\n::: {.content-visible when-profile=\"website\"}\nThe resulting chart demonstrates the power of compounded returns and the equity risk premium that has rewarded long-term shareholders. By using Python libraries like requests, pandas, and Matplotlib, we can easily download, process, and visualize financial data to better understand market trends and investment strategies.\n:::\n\n::: {.content-visible when-profile=\"presentation\"}\n\n::: {.notes}\nThe resulting chart demonstrates the power of compounded returns and the equity risk premium that has rewarded long-term shareholders. By using Python libraries like requests, pandas, and Matplotlib, we can easily download, process, and visualize financial data to better understand market trends and investment strategies.\n:::\n\n:::\n\n",
    "supporting": [
      "shiller-data-python_files/figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}